<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <title>WebSocket STOMP Chat</title>
        <style>
            body { font-family: 'Segoe UI', sans-serif; background: #f7f8fa; }
            .container {
                width: 400px; margin: 60px auto; background: #fff; padding: 32px 30px;
                border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            }
            h2 { text-align: center; color: #2c3e50; margin-bottom: 20px;}
            #chatArea {
                width: 100%; height: 250px; border: 1px solid #aaa;
                margin-bottom: 18px; overflow-y: auto; padding: 10px 7px; border-radius: 8px;
                background: #fafdff; font-size: 15px;
            }
            .row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
            input[type="text"] {
                box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px;
                font-size: 15px; padding: 9px; outline: none; background: #f9fafd;
                transition: border 0.2s;
            }
            input[type="text"]:focus { border-color: #4078c0; background: #fff; }
            #user, #room { width: 110px; }
            #msg { flex: 1; min-width: 0; }
            button {
                background: #4078c0; color: white; font-weight: bold;
                border: none; border-radius: 6px; padding: 10px 20px;
                font-size: 15px; cursor: pointer; transition: background 0.2s;
            }
            button:hover { background: #285690; }
            .btn-disconnect {
                background: #eee; color: #285690; font-weight: bold;
            }
            .btn-disconnect:hover { background: #e0e8f5; }
            .sysmsg { color: #666; font-style: italic; margin: 7px 0 3px 0;}
            .msgrow { margin-bottom: 3px;}
            .from { font-weight: bold; color: #4078c0;}
            .hidden { display: none; }
            #roomList { margin-bottom: 20px; }
            .room-item {
                padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 5px;
                cursor: pointer;
            }
            .room-item:hover { background: #e8f0ff; }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>Spring WebSocket + STOMP Chat</h2>

            <!-- Î∞© Î™©Î°ù -->
            <div id="roomList">
                <strong>Î∞© Î™©Î°ù :</strong>
                <div id="rooms"></div>
            </div>

            <!-- ÏûÖÏû• ÏòÅÏó≠ -->
            <div class="row" id="enterRow">
                <input type="text" id="user" placeholder="ÎãâÎÑ§ÏûÑ">
                <input type="text" id="room" placeholder="Î∞© Î≤àÌò∏">
<!--                <input type="text" id="postPk" placeholder="postPk">-->
<!--                <input type="text" id="memberPk" placeholder="Î∞© Î≤àÌò∏">-->
                <button onclick="connect()">Connect</button>
<!--                <button onclick="connect2()">Connect2</button>-->
            </div>

            <!-- Í∑ìÏÜçÎßê ÎåÄÏÉÅ -->
            <div class="row hidden" id="whisperRow">
                <input type="text" id="whisperTo" placeholder="Í∑ìÏÜçÎßê ÎåÄÏÉÅ (ÎãâÎÑ§ÏûÑ)">
            </div>

            <!-- Ï±ÑÌåÖ ÏòÅÏó≠ (ÏûÖÏû• ÌõÑÏóêÎßå ÌëúÏãú) -->
            <div id="chatWrapper" class="hidden">
                <div id="chatArea"></div>
                <div class="row">
                    <input type="text" id="msg" placeholder="Î©îÏãúÏßÄ">
                    <button onclick="sendMessage()">Send</button>
                    <button class="btn-disconnect" onclick="disconnect()">Disconnect</button>
                </div>
            </div>
        </div>
        <script src="js/fetchWithAuth.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        <script>
            let stompClient = null;
            let nickname = "";
            let roomId = "";

            window.onload = function () {
<!--                loadRoomList();-->
                    const socket = new WebSocket('/api/ws-chat?memberPk=19');
                    stompClient = Stomp.over(socket);

                    stompClient.connect({}, function (frame) {

                        //ÏùºÎ∞òÏ±ÑÌåÖ
                        stompClient.subscribe(`/all`, function (chat) {
                            console.log("Î©îÏãúÏßÄ ÏàòÏã†!");
                        });


                });
            };

            function loadRoomList() {

                fetchWithAuth("/api/rooms", {
                    credentials: "include",
                    headers: (localStorage.getItem("accessToken"))
                        ? { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                        : {}
                })
                    .then(response => response.json())
                    .then(data => {
                        const roomsDiv = document.getElementById("rooms");
                        const roomListDiv = document.getElementById("roomList");
                        roomsDiv.innerHTML = "";
                        if (data.length === 0) {
                            roomListDiv.classList.add("hidden");
                        } else {
                            roomListDiv.classList.remove("hidden");
                            data.forEach(room => {
                                const div = document.createElement("div");
                                div.className = "room-item";
                                div.textContent = `Î∞© Î≤àÌò∏: ${room.roomId}`;
                                div.onclick = () => {
                                    const nick = prompt("ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:");
                                    if (!nick) return;
                                    document.getElementById("user").value = nick;
                                    document.getElementById("room").value = room.roomId;
                                    connect();
                                };
                                roomsDiv.appendChild(div);
                            });
                        }
                    });
            }

            function connect() {
                nickname = document.getElementById("user").value;
                roomId = document.getElementById("room").value;

                if (!nickname || !roomId) {
                    alert("ÎãâÎÑ§ÏûÑÍ≥º Î∞© Î≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!");
                    return;
                }



                //  const socket = new WebSocket('/ws-chat');
<!--                const socket = new WebSocket('/api/ws-chat?memberPk=19');-->
<!--                stompClient = Stomp.over(socket);-->

                stompClient.connect({}, function (frame) {
                    // Ï±ÑÌåÖÎ∞© ÏûÖÏû•Ìï† Îïå Ï±ÑÌåÖÏ∞ΩÏùÑ Ï¥àÍ∏∞Ìôî
                    document.getElementById("chatArea").innerHTML = "";

                    fetchWithAuth(`api/chatting/getMessageList?roomPk=8`, {
                        method: "GET",
                        credentials: "include",
                        headers: Object.assign(
                            { "Content-Type": "application/json" },
                            localStorage.getItem("accessToken")
                                ? { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                                : {}
                        )
                    })
                    .then(response => {

                        console.log("response is ",response);
                        if (!response.ok) {
                            const text = response.text();
                            console.error("HTML ÏóêÎü¨ ÏùëÎãµ : ", text);
                            throw new Error("Î©îÏãúÏßÄ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
                        }
                        return response.json();
                    })
                    .then(messageList => {
                        console.log("Ï±ÑÌåÖ Î©îÏãúÏßÄ Î¶¨Ïä§Ìä∏:", messageList);
                        // Ïó¨Í∏∞ÏÑú messageListÎ•º Î†åÎçîÎßÅÌïòÍ±∞ÎÇò ÏÉÅÌÉúÏóê Ï†ÄÏû•
                        messageList.forEach(message => {
                           showSysMsg(`[${message.message}] - [${message.messageAt}]Ïóê ÏûÖÏû•ÌñàÏäµÎãàÎã§.`);
                        });

                    })
                    .catch(error => {
                        console.error("ÏóêÎü¨ Î∞úÏÉù:", error);
                    });

                    document.getElementById("chatWrapper").classList.remove("hidden");
                    document.getElementById("enterRow").classList.add("hidden");
                    document.getElementById("roomList").classList.add("hidden");

                    document.getElementById("whisperRow").classList.remove("hidden"); // ‚úÖ Ïó¨Í∏∞!  ÎãâÎÑ§ÏûÑ ÏûëÏÑ±


                    //ÏùºÎ∞òÏ±ÑÌåÖ
                    stompClient.subscribe(`/topic/room.${roomId}`, function (chat) {
                        const message = JSON.parse(chat.body);
                        showMessage(message.from, message.message, message.messageAt);
                    });

                    //Í∑ìÏÜçÎßê
                    stompClient.subscribe('/user/queue/private', function (message) {
                        const msg = JSON.parse(message.body);
                        alert("üí¨ Í∑ìÏÜçÎßê: " + msg.from + " - " + msg.message);
                    });

                });


            }


            async function connect2() {
                let postPk = document.getElementById("postPk").value;
                let memberPk = document.getElementById("memberPk").value;

                let response;
                try {
                    response = await fetchWithAuth(`/api/chatting/openChattingRoom`, {
                        method: "POST",
                        credentials: "include",
                        headers: Object.assign(
                            { "Content-Type": "application/json" },
                            (localStorage.getItem("accessToken"))
                                ? { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                                : {}
                        ),
                        body: JSON.stringify({ "postPk": postPk }) // üëà ÌïÑÏöîÌïú ÏöîÏ≤≠ body ÎÑ£Í∏∞
                    });

                    console.log("response : ", response);
                    if (!response.ok) {
                        const errorText = await response.text(); // ÌòπÏùÄ .json()ÎèÑ Í∞ÄÎä•
                        throw new Error("ÏÑúÎ≤Ñ Ïò§Î•ò: " + errorText);
                    }

                    const roomId = await response.json(); // ÏÑúÎ≤ÑÏóêÏÑú Î≥¥ÎÇ∏ chattingRoom.getId()
                    console.log("ÏÉùÏÑ±Îêú Ï±ÑÌåÖÎ∞© ID:", roomId);

                    // Ïó¨Í∏∞ÏÑú roomIdÎ•º Îã§Î•∏ Î°úÏßÅÏóê ÏÇ¨Ïö©
                    // Ïòà: Ï±ÑÌåÖÎ∞©ÏúºÎ°ú Ïù¥Îèô
                    // window.location.href = `/chat/${roomId}`;

                    return roomId;
                } catch (error) {
                    console.error("Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Ï§ë Ïò§Î•ò:", error);
                }


                const socket = new WebSocket('/api/ws-chat?memberPk='+memberPk);
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function (frame) {
                    // Ï±ÑÌåÖÎ∞© ÏûÖÏû•Ìï† Îïå Ï±ÑÌåÖÏ∞ΩÏùÑ Ï¥àÍ∏∞Ìôî
                    document.getElementById("chatArea").innerHTML = "";

                    fetchWithAuth(`api/chatting/getMessageList?roomPk=`+roomPk, {
                        method: "GET",
                        credentials: "include",
                        headers: Object.assign(
                            { "Content-Type": "application/json" },
                            localStorage.getItem("accessToken")
                                ? { "Authorization": "Bearer " + localStorage.getItem("accessToken") }
                                : {}
                        )
                    })
                    .then(response => {

                        console.log("response is ",response);
                        if (!response.ok) {
                            const text = response.text();
                            console.error("HTML ÏóêÎü¨ ÏùëÎãµ : ", text);
                            throw new Error("Î©îÏãúÏßÄ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
                        }
                        return response.json();
                    })
                    .then(messageList => {
                        console.log("Ï±ÑÌåÖ Î©îÏãúÏßÄ Î¶¨Ïä§Ìä∏:", messageList);
                        // Ïó¨Í∏∞ÏÑú messageListÎ•º Î†åÎçîÎßÅÌïòÍ±∞ÎÇò ÏÉÅÌÉúÏóê Ï†ÄÏû•
                        messageList.forEach(message => {
                           showSysMsg(`[${message.message}]`);
                        });

                    })
                    .catch(error => {
                        console.error("ÏóêÎü¨ Î∞úÏÉù:", error);
                    });

                    document.getElementById("chatWrapper").classList.remove("hidden");
                    document.getElementById("enterRow").classList.add("hidden");
                    document.getElementById("roomList").classList.add("hidden");

                    document.getElementById("whisperRow").classList.remove("hidden"); // ‚úÖ Ïó¨Í∏∞!  ÎãâÎÑ§ÏûÑ ÏûëÏÑ±


                    //ÏùºÎ∞òÏ±ÑÌåÖ
                    stompClient.subscribe(`/topic/room.${roomId}`, function (chat) {
                        const message = JSON.parse(chat.body);
                        showMessage(message.from, message.message);
                    });

                    //Í∑ìÏÜçÎßê
                    stompClient.subscribe('/user/queue/private', function (message) {
                        const msg = JSON.parse(message.body);
                        alert("üí¨ Í∑ìÏÜçÎßê: " + msg.from + " - " + msg.message);
                    });

                });


            }

            function disconnect() {
                if (stompClient !== null) {
                    stompClient.disconnect();
                }
                showSysMsg('Disconnected');
                document.getElementById("chatWrapper").classList.add("hidden");
                document.getElementById("enterRow").classList.remove("hidden");
                document.getElementById("roomList").classList.remove("hidden");
                document.getElementById("whisperRow").classList.add("hidden"); // ‚úÖ Ï∂îÍ∞Ä
                loadRoomList();
            }

            function sendMessage() {
                const msg = document.getElementById("msg").value;

                const toUser = document.getElementById("whisperTo").value.trim();

                if (!nickname || !msg || !roomId) {
                    alert("Î™®Îì† Ï†ïÎ≥¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
                    return;
                }

                const payload = {
                    postPk: 101,
                    message: msg,
                    roomPk: 8
                };

                console.log("msg = ",msg)

                if (toUser) {
                    payload.to = toUser; // Í∑ìÏÜçÎßê ÎåÄÏÉÅÏù¥ ÏûàÏúºÎ©¥ to Ï∂îÍ∞Ä
                }

                stompClient.send("/api/chatting/sendMessage", {}, JSON.stringify(payload));
                document.getElementById("msg").value = "";
            }

            function showMessage(from, message, messageAt) {
                const chatArea = document.getElementById("chatArea");
                chatArea.innerHTML += `<div class="msgrow"><span class="from">${from}:</span> ${message} - ${messageAt}</div>`;
                chatArea.scrollTop = chatArea.scrollHeight;
            }
            function showSysMsg(msg) {
                const chatArea = document.getElementById("chatArea");
                chatArea.innerHTML += `<div class="sysmsg">${msg}</div>`;
                chatArea.scrollTop = chatArea.scrollHeight;
            }

            document.getElementById('msg').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') sendMessage();
            });
        </script>
    </body>
</html>
